#! /usr/bin/perl -T
# vim: set filetype=perl ts=4 sw=4 sts=4 et:
# KEYSUDOERS # as an aclkeeper, regenerate sshd configs for all group members after group server changes
# KEYSUDOERS SUPEROWNERS, %%GROUP%-aclkeeper  ALL=(root)     NOPASSWD: /usr/bin/env perl -T %BASEPATH%/bin/helper/osh-groupGenerateSshdConfig --group %GROUP%
# FILEMODE 0750
# FILEOWN 0 root

#>HEADER
use common::sense;
use Getopt::Long qw(:config no_auto_abbrev no_ignore_case);

use File::Basename;
use lib dirname(__FILE__) . '/../../lib/perl';
use OVH::Bastion;
use OVH::Bastion::Helper;

# Fetch command options
my $fnret;
my ($result, @optwarns);
my $group;
eval {
    local $SIG{__WARN__} = sub { push @optwarns, shift };
    $result = GetOptions(
        "group=s" => sub { $group //= $_[1] },
        "deleted-local-port=i" => sub { $deletedLocalPort //= $_[1] },
    );
};
if ($@) { die $@ }

OVH::Bastion::Helper::check_spurious_args();

if (!$result) {
    local $" = ", ";
    HEXIT('ERR_BAD_OPTIONS', msg => "Error parsing options: @optwarns");
}

if (!$group) {
    HEXIT('ERR_MISSING_PARAMETER', msg => "Missing mandatory parameter 'group'");
}

#<HEADER

#>PARAMS:GROUP
$fnret = OVH::Bastion::is_valid_group_and_existing(group => $group, groupType => "key");
$fnret or HEXIT($fnret);
$group = $fnret->value->{'group'};
my $members    = $fnret->value->{'members'};
my $shortGroup = $fnret->value->{'shortGroup'};
#<PARAMS:GROUP

#>RIGHTSCHECK
if ($self eq 'root') {
    osh_debug "Real root, skipping checks of permissions";
}
else {
    # we check that the caller is an aclkeeper of this group
    $fnret = OVH::Bastion::is_group_aclkeeper(account => $self, group => $shortGroup, sudo => 1, superowner => 1);
    $fnret or HEXIT('ERR_NOT_ALLOWED', msg => "Sorry, you must be an aclkeeper of group $shortGroup");
}
#<RIGHTSCHECK

#>CODE
# Acquire lock to ensure thread-safe config generation
$fnret = OVH::Bastion::Helper::get_lock_fh(category => 'portforwarding');
$fnret or HEXIT($fnret);
my $lock_fh = $fnret->value;

$fnret = OVH::Bastion::Helper::acquire_lock($lock_fh);
$fnret or HEXIT($fnret);

# Get all members of the group (including guests who have specific accesses)
my @accounts_to_update;

# Get regular members
foreach my $member (@$members) {
    osh_debug("Processing member $member of group $group");
    next if $member eq 'allowkeeper';
    push @accounts_to_update, $member;
}

# Regenerate sshd config for each account
my @errors;
my @success;
foreach my $account (@accounts_to_update) {
    $fnret = OVH::Bastion::generate_account_sshd_forwarding_config(account => $account, deletedLocalPort => $deletedLocalPort);
    if ($fnret) {
        push @success, $account;
    }
    else {
        push @errors, "$account: " . $fnret->msg;
    }
}

if (@errors) {
    HEXIT(
        'ERR_PARTIAL_SUCCESS',
        msg => "Successfully regenerated sshd config for "
          . scalar(@success)
          . " accounts, but "
          . scalar(@errors)
          . " failed:\n"
          . join("\n", @errors),
        value => {
            group   => $shortGroup,
            success => \@success,
            errors  => \@errors,
        }
    );
}

HEXIT(
    'OK',
    msg   => "Successfully regenerated sshd config for " . scalar(@success) . " account(s)",
    value => {
        group    => $shortGroup,
        accounts => \@success,
    }
);
