#! /usr/bin/perl -T
# vim: set filetype=perl ts=4 sw=4 sts=4 et:
# SUDOERS %osh-selfAddPersonalAccess    ALL=(root) NOPASSWD:/usr/bin/env perl -T /opt/bastion/bin/helper/osh-accountGenerateSshdConfig --target self --account *
# SUDOERS %osh-accountAddPersonalAccess ALL=(root) NOPASSWD:/usr/bin/env perl -T /opt/bastion/bin/helper/osh-accountGenerateSshdConfig --target any --account *
# SUDOERS %osh-selfDelPersonalAccess    ALL=(root) NOPASSWD:/usr/bin/env perl -T /opt/bastion/bin/helper/osh-accountGenerateSshdConfig --target self --account *
# SUDOERS %osh-accountDelPersonalAccess ALL=(root) NOPASSWD:/usr/bin/env perl -T /opt/bastion/bin/helper/osh-accountGenerateSshdConfig --target any --account *
# KEYSUDOERS SUPEROWNERS, %%GROUP%-gatekeeper ALL=(root) NOPASSWD:/usr/bin/env perl -T %BASEPATH%/bin/helper/osh-accountGenerateSshdConfig --target any --account *
# FILEMODE 0700
# FILEOWN 0 0

#>HEADER
use common::sense;
use Getopt::Long qw(:config no_auto_abbrev no_ignore_case);

use File::Basename;
use lib dirname(__FILE__) . '/../../lib/perl';
use OVH::Bastion;
use OVH::Bastion::Helper;

# Fetch command options
my $fnret;
my ($result,  @optwarns);
my ($account, $target);
eval {
    local $SIG{__WARN__} = sub { push @optwarns, shift };
    $result = GetOptions(
        "account=s" => sub { $account //= $_[1] },
        "target=s"  => sub { $target  //= $_[1] },
    );
};
if ($@) { die $@ }

OVH::Bastion::Helper::check_spurious_args();

if (!$result) {
    local $" = ", ";
    HEXIT('ERR_BAD_OPTIONS', msg => "Error parsing options: @optwarns");
}

if (!$target) {
    HEXIT('ERR_MISSING_PARAMETER', msg => "Missing mandatory parameter 'target'");
}

#<HEADER

not defined $account and $account = $self;

#>RIGHTSCHECK
if ($target eq 'self' && $self ne $account) {
    HEXIT('ERR_SECURITY_VIOLATION',
        msg => "Attempted to modify another account while you're only allowed to do it on yourself");
}

#<RIGHTSCHECK

#>CODE
# Acquire lock to ensure thread-safe config generation
$fnret = OVH::Bastion::Helper::get_lock_fh(category => 'portforwarding');
$fnret or HEXIT($fnret);
my $lock_fh = $fnret->value;

$fnret = OVH::Bastion::Helper::acquire_lock($lock_fh);
$fnret or HEXIT($fnret);

$fnret = OVH::Bastion::generate_account_sshd_forwarding_config(account => $account);
if (!$fnret) {
    HEXIT($fnret);
}

HEXIT('OK', value => {account => $account});
